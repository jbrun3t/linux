// SPDX-License-Identifier: (GPL-2.0+ OR MIT)
/*
 * Copyright (c) 2019 BayLibre, SAS
 * Author: Neil Armstrong <narmstrong@baylibre.com>
 */

/dts-v1/;

#include "meson-sm1.dtsi"
#include "meson-khadas-vim3.dtsi"
#include <dt-bindings/sound/meson-g12a-tohdmitx.h>
#include <dt-bindings/clock/axg-audio-clkc.h>

/ {
	compatible = "khadas,vim3l", "amlogic,sm1";
	model = "Khadas VIM3L";

	earc_dir: audio-codec-0 {
		#sound-dai-cells = <0>;
		compatible = "linux,spdif-dir";
		status = "okay";
		sound-name-prefix = "EARC_DIR";
	};

	vddcpu: regulator-vddcpu {
		/*
		 * Silergy SY8030DEC Regulator.
		 */
		compatible = "pwm-regulator";

		regulator-name = "VDDCPU";
		regulator-min-microvolt = <690000>;
		regulator-max-microvolt = <1050000>;

		pwm-supply = <&vsys_3v3>;

		pwms = <&pwm_AO_cd 1 1250 0>;
		pwm-dutycycle-range = <100 0>;

		regulator-boot-on;
		regulator-always-on;
	};

	spdif_dit: audio-codec-100 {
		#sound-dai-cells = <0>;
		compatible = "linux,spdif-dit";
		status = "okay";
		sound-name-prefix = "DIT";
	};

	spdif_dir: audio-codec-101 {
		#sound-dai-cells = <0>;
		compatible = "linux,spdif-dir";
		status = "okay";
		sound-name-prefix = "DIR";
	};

	i2s_dac: audio-codec-102 {
		#sound-dai-cells = <0>;
		compatible = "ess,es9038q2m";
		status = "okay";
		sound-name-prefix = "ES9038";
	};

	sound {
		model = "G12B-KHADAS-VIM3L";
		audio-aux-devs = <&tdmin_a>, <&tdmin_b>,
				 <&tdmout_a>, <&tdmout_b>;
		audio-widgets = "Line", "Lineout";
		audio-routing = "TDMOUT_A IN 0", "FRDDR_A OUT 0",
				"TDMOUT_B IN 0", "FRDDR_A OUT 1",
				"SPDIFOUT_A IN 0", "FRDDR_A OUT 3",
				"TDMOUT_A IN 1", "FRDDR_B OUT 0",
				"TDMOUT_B IN 1", "FRDDR_B OUT 1",
				"SPDIFOUT_A IN 1", "FRDDR_B OUT 3",
				"TDMOUT_A IN 2", "FRDDR_C OUT 0",
				"TDMOUT_B IN 2", "FRDDR_C OUT 1",
				"SPDIFOUT_A IN 2", "FRDDR_C OUT 3",
				"TDM_A Playback", "TDMOUT_A OUT",
				"TDM_B Playback", "TDMOUT_B OUT",
				"TDMIN_A IN 0", "TDM_A Capture",
				"TDMIN_A IN 1", "TDM_B Capture",
				"TDMIN_A IN 13", "TDM_A Loopback",
				"TDMIN_A IN 14", "TDM_B Loopback",
				"TDMIN_B IN 0", "TDM_A Capture",
				"TDMIN_B IN 1", "TDM_B Capture",
				"TDMIN_B IN 13", "TDM_A Loopback",
				"TDMIN_B IN 14", "TDM_B Loopback",
				"TODDR_A IN 0", "TDMIN_A OUT",
				"TODDR_B IN 0", "TDMIN_A OUT",
				"TODDR_C IN 0", "TDMIN_A OUT",
				"TODDR_A IN 1", "TDMIN_B OUT",
				"TODDR_B IN 1", "TDMIN_B OUT",
				"TODDR_C IN 1", "TDMIN_B OUT",
				"TODDR_A IN 3", "SPDIFIN Capture",
				"TODDR_B IN 3", "SPDIFIN Capture",
				"TODDR_C IN 3", "SPDIFIN Capture",
				"TODDR_A IN 11", "EARCRX OUT",
				"TODDR_B IN 11", "EARCRX OUT",
				"TODDR_C IN 11", "EARCRX OUT",
				"Lineout", "ES9038 DACL",
				"Lineout", "ES9038 DACR";

		dai-link-8 {
			sound-dai = <&earcrx>;

			codec {
				sound-dai = <&earc_dir>;
			};
		};

		/* 2ch external on the 40pins headers */
		dai-link-100 {
			sound-dai = <&tdmif_b>;
			dai-format = "i2s";
			continuous-clock;
			dai-tdm-slot-tx-mask-0 = <1 1>;

			codec {
				sound-dai = <&i2s_dac>;
			};

		};

		dai-link-101 {
			sound-dai = <&spdifout_a>;

			codec {
				sound-dai = <&spdif_dit>;
			};
		};

		dai-link-102 {
			sound-dai = <&spdifin>;

			codec {
				sound-dai = <&spdif_dir>;
			};
		};
	};
};

&cpu0 {
	cpu-supply = <&vddcpu>;
	operating-points-v2 = <&cpu_opp_table>;
	clocks = <&clkc CLKID_CPU_CLK>;
};

&cpu1 {
	cpu-supply = <&vddcpu>;
	operating-points-v2 = <&cpu_opp_table>;
	clocks = <&clkc CLKID_CPU1_CLK>;
};

&cpu2 {
	cpu-supply = <&vddcpu>;
	operating-points-v2 = <&cpu_opp_table>;
	clocks = <&clkc CLKID_CPU2_CLK>;
};

&cpu3 {
	cpu-supply = <&vddcpu>;
	operating-points-v2 = <&cpu_opp_table>;
	clocks = <&clkc CLKID_CPU3_CLK>;
};

&pwm_AO_cd {
	pinctrl-0 = <&pwm_ao_d_e_pins>;
	pinctrl-names = "default";
	status = "okay";
};

/*
 * The VIM3 on-board  MCU can mux the PCIe/USB3.0 shared differential
 * lines using a FUSB340TMX USB 3.1 SuperSpeed Data Switch between
 * an USB3.0 Type A connector and a M.2 Key M slot.
 * The PHY driving these differential lines is shared between
 * the USB3.0 controller and the PCIe Controller, thus only
 * a single controller can use it.
 * If the MCU is configured to mux the PCIe/USB3.0 differential lines
 * to the M.2 Key M slot, uncomment the following block to disable
 * USB3.0 from the USB Complex and enable the PCIe controller.
 * The End User is not expected to uncomment the following except for
 * testing purposes, but instead rely on the firmware/bootloader to
 * update these nodes accordingly if PCIe mode is selected by the MCU.
 */
/*
&pcie {
	status = "okay";
};

&usb {
	phys = <&usb2_phy0>, <&usb2_phy1>;
	phy-names = "usb2-phy0", "usb2-phy1";
};
 */

&sd_emmc_a {
	sd-uhs-sdr50;
};

&earcrx {
	status = "okay";
};

&spdifin {
	pinctrl-0 = <&spdif_in_h_pins>;
	pinctrl-names = "default";
	status = "okay";
};

&spdifout_a {
	pinctrl-0 = <&spdif_ao_out_pins>;
	pinctrl-names = "default";
	status = "okay";
};

&tdmif_b {
	status = "okay";
	pinctrl-0 = <&tdm_b_fs_pins>, <&tdm_b_sclk_pins>, <&tdm_b_dout0_pins>;
	pinctrl-names = "default";
	assigned-clocks = <&clkc_audio AUD_CLKID_TDM_SCLK_PAD1>,
			  <&clkc_audio AUD_CLKID_TDM_LRCLK_PAD1>;
	assigned-clock-parents = <&clkc_audio AUD_CLKID_MST_B_SCLK>,
				 <&clkc_audio AUD_CLKID_MST_B_LRCLK>;
	assigned-clock-rates = <0>, <0>;
};

&tdmin_b {
	status = "okay";
};

&tdmout_b {
	status = "okay";
};
